"""
–ú–û–î–£–õ–¨ AI-–ê–°–°–ò–°–¢–ï–ù–¢–ê –ù–ê GOOGLE VISION
–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ –ø–æ —Ñ–æ—Ç–æ (1000 —Ñ–æ—Ç–æ/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
"""

import io
import json
import re
import asyncio
from typing import Dict, Optional, List
from datetime import datetime
from PIL import Image
import logging

from google.cloud import vision
from google.oauth2 import service_account

from config import GOOGLE_VISION_CREDENTIALS

logger = logging.getLogger(__name__)


class GoogleVisionAssistant:
    """–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ —á–µ—Ä–µ–∑ Google Vision API"""
    
    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    CATEGORY_KEYWORDS = {
        "üõí –ü—Ä–æ–¥—É–∫—Ç—ã": [
            "–ø—è—Ç—ë—Ä–æ—á–∫–∞", "–ø—è—Ç–µ—Ä–æ—á–∫–∞", "–º–∞–≥–Ω–∏—Ç", "–ª–µ–Ω—Ç–∞", "–∞—à–∞–Ω",
            "–¥–∏–∫—Å–∏", "–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫", "–≤–∫—É—Å–≤–∏–ª–ª", "–ø—Ä–æ–¥—É–∫—Ç—ã", "–º–æ–ª–æ–∫–æ",
            "—Ö–ª–µ–±", "–æ–≤–æ—â–∏", "—Ñ—Ä—É–∫—Ç—ã", "–º—è—Å–æ", "—Å—ã—Ä", "–∫–æ–ª–±–∞—Å–∞",
            "–ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "–≥–∞—Å—Ç—Ä–æ–Ω–æ–º", "–ø—Ä–æ–¥—É–∫—Ç—ã",
            "–≤–∫—É—Å–Ω–æ", "–µ–¥–∞", "–ø—Ä–æ–¥—É–∫—Ç"
        ],
        "üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": [
            "–ª—É–∫–æ–π–ª", "–≥–∞–∑–ø—Ä–æ–º", "—Ä–æ—Å–Ω–µ—Ñ—Ç—å", "–∞–∑—Å", "–∑–∞–ø—Ä–∞–≤–∫–∞",
            "–±–µ–Ω–∑–∏–Ω", "—Ç–æ–ø–ª–∏–≤–æ", "–∞–≤—Ç–æ–∑–∞–ø—Ä–∞–≤–æ—á–Ω—ã–π", "—Ç–∞–∫—Å–∏", "–∞–∏—Å",
            "–Ω–µ—Ñ—Ç—å", "–≥–∞–∑", "–∞–≤—Ç–æ"
        ],
        "üíä –õ–µ–∫–∞—Ä—Å—Ç–≤–∞ –∏ –ª–µ—á–µ–Ω–∏–µ": [
            "–∞–ø—Ç–µ–∫–∞", "–∞–ø—Ç–µ–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–∞", "—Ç–∞–±–ª–µ—Ç–∫–∏", "–≤–∏—Ç–∞–º–∏–Ω—ã",
            "–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã", "–∑–¥–æ—Ä–æ–≤—å–µ", "–º–µ–¥—Ç–µ—Ö–Ω–∏–∫–∞", "–¥–æ–∫—Ç–æ—Ä", "–∑–¥—Ä–∞–≤",
            "—Ñ–∞—Ä–º", "–º–µ–¥"
        ],
        "üè† –ö–æ–º–º—É–Ω–∞–ª–∫–∞": [
            "–∂–∫—Ö", "–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ", "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "–≤–æ–¥–∞", "–≥–∞–∑",
            "–æ—Ç–æ–ø–ª–µ–Ω–∏–µ", "–∫–≤–∞—Ä—Ç–ø–ª–∞—Ç–∞", "—Ç—ç—Ü", "—ç–Ω–µ—Ä–≥–æ"
        ],
        "üéÆ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —Ö–æ–±–±–∏": [
            "–∫–∏–Ω–æ", "—Ç–µ–∞—Ç—Ä", "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–ø–∏—Ü—Ü–∞", "—Å—É—à–∏",
            "–±—É—Ä–≥–µ—Ä", "–º–∞–∫–¥–æ–Ω–∞–ª—å–¥—Å", "–±—É—Ä–≥–µ—Ä –∫–∏–Ω–≥", "–∫—Ñ—Å", "–∫–æ—Ñ–µ",
            "—Å—Ç–æ–ª–æ–≤–∞—è", "–æ–±–µ–¥", "–±–∞—Ä", "–∫–æ—Ñ–µ–π–Ω—è"
        ],
        "üëï –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å": [
            "–æ–¥–µ–∂–¥–∞", "–æ–±—É–≤—å", "–¥–∂–∏–Ω—Å—ã", "—Ñ—É—Ç–±–æ–ª–∫–∞", "–∫—Ä–æ—Å—Å–æ–≤–∫–∏",
            "–º–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã", "zara", "h&m", "adidas", "nike", "–ø–æ–∫—É–ø–∫–∏",
            "–≤–µ—â–∏", "–∫–æ—Ñ—Ç–∞", "–∫—É—Ä—Ç–∫–∞", "–±–æ—Ç–∏–Ω–∫–∏"
        ],
        "üî® –î–æ–º/—Ä–µ–º–æ–Ω—Ç": [
            "—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã", "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "—Ä–µ–º–æ–Ω—Ç", "–ª–µ—Ä—É–∞ –º–µ—Ä–ª–µ–Ω",
            "–æ–±–∏", "–∫–∞—Å—Ç–æ—Ä–∞–º–∞", "—Ö–æ–∑—Ç–æ–≤–∞—Ä—ã", "—Å—Ç—Ä–æ–π", "—Ö–æ–∑", "–º–∞–≥–∞–∑–∏–Ω",
            "–¥–ª—è –¥–æ–º–∞"
        ],
        "üê± –ö–æ—à–∫–∞": [
            "–∑–æ–æ–º–∞–≥–∞–∑–∏–Ω", "–∫–æ—Ä–º", "–Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–≤–µ—Ç–∫–ª–∏–Ω–∏–∫–∞",
            "–∂–∏–≤–æ—Ç–Ω—ã–µ", "–∫–æ—à–∫–∞", "—Å–æ–±–∞–∫–∞", "–∑–æ–æ—Ç–æ–≤–∞—Ä—ã"
        ]
    }
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Vision –∫–ª–∏–µ–Ω—Ç–∞"""
        try:
            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ —Å—Ç—Ä–æ–∫–∏
            credentials_info = json.loads(GOOGLE_VISION_CREDENTIALS)
            credentials = service_account.Credentials.from_service_account_info(
                credentials_info
            )
            self.client = vision.ImageAnnotatorClient(credentials=credentials)
            logger.info("‚úÖ Google Vision –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google Vision: {e}")
            self.client = None
    
    async def optimize_photo(self, photo_bytes: bytes) -> bytes:
        """–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è Google Vision"""
        try:
            img = Image.open(io.BytesIO(photo_bytes))
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB
            if img.mode != 'RGB':
                img = img.convert('RGB')
            
            # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
            max_size = 1024
            if max(img.size) > max_size:
                ratio = max_size / max(img.size)
                new_size = tuple(int(dim * ratio) for dim in img.size)
                img = img.resize(new_size, Image.Resampling.LANCZOS)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
            output = io.BytesIO()
            img.save(output, format='JPEG', quality=90, optimize=True)
            
            return output.getvalue()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: {e}")
            return photo_bytes
    
    async def extract_text(self, photo_bytes: bytes) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        if not self.client:
            return ""
        
        try:
            # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ
            optimized_bytes = await self.optimize_photo(photo_bytes)
            
            # –°–æ–∑–¥–∞–µ–º image –æ–±—ä–µ–∫—Ç
            image = vision.Image(content=optimized_bytes)
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ)
            response = await asyncio.to_thread(
                self.client.text_detection,
                image=image
            )
            
            texts = response.text_annotations
            
            if texts:
                # –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç - –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Ü–µ–ª–∏–∫–æ–º
                return texts[0].description
            
            return ""
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞: {e}")
            return ""
    
    def parse_receipt(self, text: str) -> Dict:
        """–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç —á–µ–∫–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ"""
        result = {
            'total': 0,
            'store': '',
            'date': '',
            'category': 'üì¶ –î—Ä—É–≥–æ–µ',
            'items': [],
            'confidence': 0,
            'raw_text': text[:500]
        }
        
        if not text:
            return result
        
        lines = text.split('\n')
        text_upper = text.upper()
        
        # 1Ô∏è‚É£ –ò–©–ï–ú –°–£–ú–ú–£
        total_patterns = [
            r'–ò–¢–û–ì–û[\s:]*([\d\s,\.]+)',
            r'–°–£–ú–ú–ê[\s:]*([\d\s,\.]+)',
            r'–í–°–ï–ì–û[\s:]*([\d\s,\.]+)',
            r'([\d\s,\.]+)\s*‚ÇΩ',
            r'([\d\s,\.]+)\s*–†–£–ë',
            r'([\d\s,\.]+)\s*–†',
        ]
        
        for line in lines:
            for pattern in total_patterns:
                match = re.search(pattern, line, re.IGNORECASE)
                if match:
                    try:
                        total_str = match.group(1).replace(' ', '').replace(',', '.')
                        result['total'] = float(total_str)
                        result['confidence'] += 40
                        break
                    except:
                        pass
        
        # 2Ô∏è‚É£ –ò–©–ï–ú –ù–ê–ó–í–ê–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê
        store_indicators = ["–û–û–û", "–ò–ü", "–ú–ê–ì–ê–ó–ò–ù", "–°–£–ü–ï–†–ú–ê–†–ö–ï–¢", "–¢–û–†–ì"]
        for line in lines[:10]:
            line = line.strip()
            if line and len(line) > 3:
                for indicator in store_indicators:
                    if indicator in line.upper():
                        result['store'] = line
                        result['confidence'] += 20
                        break
                
                # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä
                if not result['store'] and line.isupper() and not any(c.isdigit() for c in line):
                    result['store'] = line
                    result['confidence'] += 10
        
        # 3Ô∏è‚É£ –ò–©–ï–ú –î–ê–¢–£
        date_patterns = [
            r'(\d{2})[.\-](\d{2})[.\-](\d{2,4})',
            r'(\d{2})[.\-](\d{2})[.\-](\d{4})',
        ]
        
        for line in lines:
            for pattern in date_patterns:
                match = re.search(pattern, line)
                if match:
                    day, month, year = match.groups()
                    if len(year) == 4:
                        year = year[-2:]
                    result['date'] = f"{day}.{month}.{year}"
                    result['confidence'] += 20
                    break
        
        # 4Ô∏è‚É£ –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ö–ê–¢–ï–ì–û–†–ò–Æ
        store_lower = result['store'].lower()
        text_lower = text.lower()
        
        for category, keywords in self.CATEGORY_KEYWORDS.items():
            for keyword in keywords:
                if keyword in store_lower or keyword in text_lower:
                    result['category'] = category
                    result['confidence'] += 20
                    break
        
        # 5Ô∏è‚É£ –°–û–ë–ò–†–ê–ï–ú –¢–û–í–ê–†–´
        items = []
        for line in lines:
            line = line.strip()
            if len(line) < 5 or any(x in line.upper() for x in ['–ò–¢–û–ì–û', '–°–£–ú–ú–ê', '–ö–ê–°–°–ò–†']):
                continue
            
            if re.search(r'\d+[\.,]\d{2}', line):
                item_name = re.sub(r'\s+\d+[\.,]\d{2}.*$', '', line)
                item_name = re.sub(r'\s+\d+$', '', item_name)
                if item_name and len(item_name) > 2 and item_name not in items:
                    items.append(item_name[:50])
        
        result['items'] = items[:10]
        
        if result['total'] > 0:
            result['confidence'] += 10
        if result['items']:
            result['confidence'] += 10
        
        return result
    
    async def recognize_receipt(self, photo_bytes: bytes) -> Dict:
        """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —á–µ–∫–∞"""
        try:
            text = await self.extract_text(photo_bytes)
            result = self.parse_receipt(text)
            result['success'] = bool(text)
            result['error'] = None if text else "–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω"
            
            logger.info(f"‚úÖ –ß–µ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: {result['total']} ‚ÇΩ, {result['store']}")
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
            return {
                'success': False,
                'error': str(e),
                'total': 0,
                'store': '',
                'category': 'üì¶ –î—Ä—É–≥–æ–µ'
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
vision_assistant = GoogleVisionAssistant()